---
title: "Converting between Hiearchical Representations"
author: "Matt Piekenbrock"
output:
  pdf_document: default
  html_notebook: default
---
```{r setup}
  suppressMessages(library("data.table", quietly = T))
```
Starting with some random data...
```{r Test_Points}
  tdata <- data.table::data.table(x=rnorm(30), y=rnorm(30))
  norm_lim <- c(-qnorm(0.999), qnorm(0.999))
  plot(tdata, pch=20, xlim=norm_lim, ylim=norm_lim, main="tdata")
  text(tdata, labels=1:nrow(tdata), pos = 3)
```

```{r Reachability_Plot}
  library("dbscan")
  opt <- dbscan::optics(tdata, eps = Inf, minPts = 2)
  real_reachdist <- opt$reachdist[opt$reachdist != Inf]
  plot(opt, ylim=range(0, max(real_reachdist) + sd(real_reachdist)))
  text(x = 1:nrow(tdata), y=c(max(real_reachdist), opt$reachdist[opt$order][-1]), 
       pos=3, labels = opt$order)
```
 
```{r Reachability Comparison}
  par("mfrow"=c(2, 1), "mar"=c(2, 2, 2, 1))
  
  # Compare Single Linkage and OPTICS conversion plots 
  ref <- as.dendrogram(hclust(dist(tdata), method="single"))
  opt_dend <- as.dendrogram(opt)
  ref_order <- order.dendrogram(ref)
  
  plot(reorder(ref, ref_order, agglo.FUN = mean), main="Single Linkage", sub=NA)
  plot(reorder(opt_dend, ref_order, agglo.FUN = mean), main="OPTICS-converted", sub=NA)
```
Following the original paper [1], there is *only* a strict equivalence between a reachability plot and a dendrogram when $minPts = 2$ and $\epsilon = \infty$. 

```{r}
  # Use mean to *hopefully* prevent isomorphisms
  ref_reo <- reorder(ref, ref_order, agglo.FUN = mean)
  opt_dend_reo <- reorder(opt_dend, ref_order, agglo.FUN = mean)
  all.equal(ref_reo, opt_dend_reo)
```
Sometimes (but not always), an error message pops up talking about the differences between character-type vs. numeric/integer-type labels; the reference labels just need to be converted. Sometimes the `hclust` or `as.dendrogram` implementations will _not_ use character-type labels, however this goes against the stats packages documentation on what a "label" should be. It's also further noted in the dendextend package that the label attribute should be a character-type to prevent other packages from mishandling dendrograms. Thus, for the implementation for the DBSCAN package, I used character-type labels. A strict equivalence can still be obtained. 
```{r}
 suppressMessages(library("stats", quietly = T))
 ref_reo <- dendrapply(ref, function(x) { 
   attributes(x)$label <- as.character(attr(x, "label")); x 
 })
 all.equal(ref_reo, opt_dend_reo)
```
Although there is only a strict equivalence[1] for $minPts = 2$ and $\epsilon = \infty$, you can still convert between the two for points greater than $minPts = 2$, reducing the so-called "Single-Link effect" 
```{r}
  opt <- dbscan::optics(tdata, eps=Inf, minPts = 4)
  plot(as.dendrogram(opt), main="OPTICS (minPts=4)")
```
Normally, the resulting dendrogram converted from a reachability plot will be an isomorphism of the dendrograms produced by the `hclust` package, with the leaves of the dendrogram matching the ordering of OPTICS original ordering result. The relation is also symmetric when converting a previously-converted dendrogram to a reachability plot, or vice-versa. 
```{r Comparison}
  print(all(as.reachability(as.dendrogram(opt))$reachdist == opt$reachdist[opt$order]))
  print(all(as.reachability(as.dendrogram(opt))$order == opt$order))
```
( Symmetric relation shown visually below )
```{r Reachability_Plot_v2}
  opt <- dbscan::optics(tdata, eps = Inf, minPts = 2)
  rp <- as.reachability(as.dendrogram(opt))
  par("mfrow"=c(2, 1), "mar"=c(2, 2, 2, 1))
  
  # Plot Original Reachability 
  plot(opt)
  text(x = 1:length(opt$order), y=opt$reachdist[opt$order], pos=3, labels = opt$order)
  
  # Plot Dendogram --> Reachability conversion 
  plot(rp$reachdist, ylim=range(0, max(rp$reachdist[-1]) + sd(rp$reachdist[-1])),
       type="h", ylab = "Reachability dist.",
       xlab = "OPTICS order", main = "Reachability Plot (converted)")
  text(x = 1:length(rp$order), y=rp$reachdist, pos=3, labels = rp$order)
```
I then extended the visualization to include the results of the two OPTICS cluster extraction methods--the DBSCAN-like $\epsilon$ extraction method is shown first along with its corresponding hull plot, and then the $\xi$ method: 
```{r dendextend Extension}
  suppressMessages(library("dendextend", quietly = T))
  opt <- dbscan::optics(tdata, eps = Inf, minPts = 2, eps_cl = 0.4)
  test <- as.dendrogram(opt)
  
  # Plot OPTICS clustering on dendrogram (eps) 
  plot(opt, dendrogram = T)
  abline(h = opt$eps_cl, lty = 2)
  # Versus the Hull plot
  dbscan::hullplot(tdata, opt)
```

To distinguish the $\xi$ method from the DBSCAN-like clustering, I colored the entire branches (starting with the largest, so there may be overlap )
```{r}
  # With Xi clustering 
  opt <- dbscan::optics(tdata, eps = Inf, minPts = 2, xi = 0.005)
  plot(opt, dendrogram = T)
```

```{r}
  # Convex hull plot 
  print(dbscan::hullplot(tdata, opt))
```
In practice, the clusters are only colored in the dendrogram structures if the `dendextend` package is installed; otherwise, the normal base dendrogram without colors is displayed. 

__References:__ 
1. Sander, JÃ¶rg, et al. "Automatic extraction of clusters from hierarchical clustering representations." Pacific-Asia Conference on Knowledge Discovery and Data Mining. Springer Berlin Heidelberg, 2003.


